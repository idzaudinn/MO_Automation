<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Payout Analysis</title>
    <style>
        /* Dark, professional theme */
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #ddd;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: left;
            margin: 0 0 10px 0;  /* Remove left margin */
            font-size: 24px;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 10px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        h2 {
            text-align: left;
            margin: 0 0 20px 0;  /* Remove left margin */
            font-size: 18px;
            font-weight: normal;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 20px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #bbb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #444;
            color: #fff;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #444;
        }
        th, td {
            padding: 8px;
            border: 1px solid #666;
            text-align: left;
        }
        th {
            background: #555;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        canvas {
            width: 100%;
            max-height: 300px;
            background: #111;
        }
        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .table-wrapper {
            flex: 1;
        }
        .combined-table th,
        .combined-table td {
            width: 20%;
            text-align: center;
        }

        /* Add these new styles */
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: auto;
            margin-top: 20px;
        }

        .left-side {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 400px;  /* Fixed width of 400px */
        }

        .left-column, .right-column, .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .right-column {
            flex: 1;  /* Takes remaining space */
        }

        .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            text-align: left;  /* Ensure all text aligns left */
        }

        .instruction-box h3 {
            text-align: left;  /* Ensure header is also left-aligned */
            margin-bottom: 15px;
        }

        .instruction-box ol {
            color: #fff;
            margin-left: 20px;
            line-height: 1.0;
            padding-left: 0;  /* Reduce default padding */
            text-align: left;
        }

        .instruction-box li {
            text-align: left;
            margin-bottom: 8px;  /* Add some spacing between list items */
        }

        /* Update container style */
        .container {
            max-width: none;
            margin: 0;
            background: none;
            padding: 0;
            box-shadow: none;
        }

        /* Adjust table wrapper for right column */
        .tables-container {
            margin-top: 0;
        }

        .table-wrapper {
            margin-top: 20px;
        }
        
        /* Add hyperlink styles */
        a {
            color: #66b3ff;  /* Light blue color */
            text-decoration: none;  /* Removes underline */
        }

        a:hover {
            color: #99ccff;  /* Slightly lighter blue on hover */
            text-decoration: underline;  /* Adds underline on hover */
        }

        a:visited {
            color: #66b3ff;  /* Keeps visited links the same color */
        }

        a:active {
            color: #3399ff;  /* Slightly darker when clicked */
        }

        /* Add button styling */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: background-color 0.3s;
            background-color: #ff4444;
            color: white;
        }

        button:hover {
            background-color: #ff0000;
        }

        /* Remove the analyze button specific styles */
        #analyzeBtn {
            display: none;
        }

        /* Add these new styles */
        .file-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-input-group input[type="file"] {
            flex: 1;
            margin-bottom: 0;  /* Override previous margin */
        }

        .remove-file-btn {
            background: #ff4444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: auto;  /* Override previous width: 100% */
        }

        .remove-file-btn:hover {
            background: #ff0000;
        }
    </style>
</head>
<body>

    <h1>Commission Payout Analysis</h1>
    <h2>Use this tool to check the general commissions data between MT5, Metabase and to find the discrepancies based on the report dates. 
        Please use the main affiliate report for the analysis</h2>

    <div class="main-container">
        <!-- Left Side (contains both upper and lower sections) -->
        <div class="left-side">
            <!-- Upper Left Section -->
            <div class="left-column">
                <!-- File Inputs -->
                <div class="upload-section">
                    <h3>Upload Files</h3>
                    
                    <label for="mt5Report">MT5 Report (HTML)</label>
                    <div class="file-input-group">
                        <input type="file" id="mt5Report" accept=".html">
                        <button class="remove-file-btn" onclick="removeFile('mt5Report')">Remove</button>
                    </div>

                    <label for="metabaseReport">Metabase Report (CSV)</label>
                    <div class="file-input-group">
                        <input type="file" id="metabaseReport" accept=".csv">
                        <button class="remove-file-btn" onclick="removeFile('metabaseReport')">Remove</button>
                    </div>

                    <div class="button-group">
                        <button id="resetBtn" onclick="resetFiles()">Reset</button>
                    </div>
                </div>

                <!-- Summary Results -->
                <div class="results" id="summaryResults"></div>
            </div>

            <!-- Lower Left Section - Instructions -->
            <div class="instruction-box">
                <h3>Instructions</h3>
                <ol>
                    <li>Upload MT5 Report (HTML format)</li>
                    <li>Upload Metabase Report (CSV format)</li>
                    <li>The results will be displayed in the right column</li>
                    <li>Review the Summary for any discrepancies</li>
                </ol>
                <h3>MT5 Report</h3>
                <ol>
                    <li>Please fetch the MT5 report from the <a href="https://deriv-group.slack.com/archives/C03EAHR4P2L" target="_blank"><i>#sideoffice_mt5</i></a> channel</li>
                    <li>Save the generated file</li>
                    <li>Upload the MT5 report to the <i>Upload MT5 Report (HTML)</i> section</li>
                </ol>
                <h3>Metabase Report</h3>
                <ol>
                    <li>Please fetch the Metabase report from <a href="https://metabase-bi.4x.my/dashboard/1446-marketing-assistance-response-keyworker-dashboard?affiliate_id=266497&client_cr=&client_mt5_=&end_date=&ib_main_mt5=&start_date=&tab=272-ai-initiative-1" target="_blank"><i>Metabase Agent_MARK</i></a> channel</li>
                    <li>Save the generated file as CSV</li>
                    <li>Upload the Metabase report to the <i>Upload Metabase Report (CSV)</i> section</li>
                </ol>
                    
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- New Commission Summary Table -->
            <div class="tables-container">
                <div class="table-wrapper">
                    <h3>Commission Summary</h3>
                    <table id="commissionSummaryTable" class="combined-table">
                        <tr>
                            <th rowspan="2">Date</th>
                            <th colspan="2">Main</th>
                            <th colspan="2">Tech</th>
                        </tr>
                        <tr>
                            <th>Expected</th>
                            <th>Credited</th>
                            <th>Expected</th>
                            <th>Credited</th>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Existing Combined Table -->
            <div class="tables-container">
                <div class="table-wrapper">
                    <h3>Combined Commissions Data</h3>
                    <table id="mt5Table" class="combined-table">
                        <tr>
                            <th colspan="2" style="width: 40%">MT5</th>
                            <th colspan="2" style="width: 40%">Metabase</th>
                            <th style="width: 20%">Discrepancies</th>
                        </tr>
                        <tr>
                            <th style="width: 20%">Date</th>
                            <th style="width: 20%">Commission</th>
                            <th style="width: 20%">Date</th>
                            <th style="width: 20%">Recalculated Commission</th>
                            <th style="width: 20%">Difference</th>
                        </tr>
                    </table>
                    <table id="metabaseTable" style="display: none;"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Move canvas outside or remove if not needed -->
    <canvas id="comparisonChart" style="display: none;"></canvas>

    <script>
        let mt5Data = [];
        let metabaseData = [];

        document.getElementById('mt5Report').addEventListener('change', function(event) {
            const file = event.target.files[0];
            readMT5File(file);
        });

        document.getElementById('metabaseReport').addEventListener('change', function(event) {
            const file = event.target.files[0];
            readMetabaseFile(file);
        });

        function standardizeDateFormat(dateString) {
            try {
                // Remove any quotes and trim whitespace
                dateString = dateString.replace(/"/g, '').trim();
                
                // Handle DD-MM-YYYY format
                if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                    let [day, month, year] = dateString.split('-');
                    return `${year}-${month}-${day}`;
                }
                
                // Handle DD.MM.YYYY format
                if (dateString.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    let [day, month, year] = dateString.split('.');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                // If already in YYYY-MM-DD format, return as is
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateString;
                }

                // For any other format, parse and convert
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                // Format as YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Error parsing date:', dateString);
                return dateString;
            }
        }

        function readMT5File(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(event.target.result, "text/html");
                const rows = doc.querySelectorAll("tr");

                let commissionData = {};
                let totalMT5Commission = 0;
                
                rows.forEach(row => {
                    const columns = row.getElementsByTagName("td");

                    if (columns.length >= 12) {  
                        let fullDate = columns[0].textContent.trim();
                        let type = columns[3].textContent.trim();
                        let commission = parseFloat(columns[11].textContent.trim()) || 0;
                        
                        if (type === "daily agent commission") {
                            let standardDate = standardizeDateFormat(fullDate);
                            
                            if (commissionData[standardDate]) {
                                commissionData[standardDate] += commission;
                            } else {
                                commissionData[standardDate] = commission;
                            }
                            totalMT5Commission += commission;
                        }
                    }
                });

                window.mt5CommissionData = commissionData;
                window.mt5Total = totalMT5Commission;
                
                console.log('MT5 Data after standardization:', commissionData); // Debug log
                updateSummaryAndTable();
            };
            reader.readAsText(file);
        }

        function readMetabaseFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split("\n").map(line => line.trim());

                let metabaseData = {};
                let totalCommission = 0;

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;

                    let row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g);
                    
                    if (row.length >= 3) {
                        try {
                            let standardDate = standardizeDateFormat(row[0]);
                            let commission = parseFloat(row[2].replace(/"/g, '').trim());

                            if (!isNaN(commission)) { 
                                metabaseData[standardDate] = (metabaseData[standardDate] || 0) + commission;
                                totalCommission += commission;
                            }
                        } catch (e) {
                            console.error('Error processing row:', row, e);
                        }
                    }
                }

                window.metabaseCommissionData = metabaseData;
                window.metabaseTotal = totalCommission;
                
                console.log('Metabase Data after standardization:', metabaseData); // Debug log
                updateSummaryAndTable();
            };
            reader.readAsText(file);
        }

        function updateSummaryAndTable() {
            const mt5Data = window.mt5CommissionData || {};
            const metabaseData = window.metabaseCommissionData || {};
            const mt5Total = window.mt5Total || 0;
            const metabaseTotal = window.metabaseTotal || 0;

            // Check if either report is missing
            const isMT5Missing = Object.keys(mt5Data).length === 0;
            const isMetabaseMissing = Object.keys(metabaseData).length === 0;

            console.log('Updating table with:', { mt5Data, metabaseData }); // Debug log

            // Create combined set of dates
            let allDates = new Set([
                ...Object.keys(mt5Data),
                ...Object.keys(metabaseData)
            ]);

            // Generate table HTML with the new class
            let tableHTML = `
                <tr>
                    <th colspan="2" style="width: 40%">MT5</th>
                    <th colspan="2" style="width: 40%">Metabase</th>
                    <th style="width: 20%">Discrepancies</th>
                </tr>
                <tr>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Commission</th>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Recalculated Commission</th>
                    <th style="width: 20%">Difference</th>
                </tr>
            `;

            // Sort dates and create rows
            [...allDates].sort().forEach(date => {
                const mt5Value = mt5Data[date] || 0;
                const metabaseValue = metabaseData[date] || 0;
                const discrepancy = (mt5Value - metabaseValue).toFixed(2);
                
                // Only show discrepancy if it's not -0.00 or 0.00
                const displayDiscrepancy = discrepancy === '-0.00' || discrepancy === '0.00' ? '0.00' : discrepancy;
                
                // Add background color for discrepancies
                const discrepancyStyle = displayDiscrepancy === '0.00' ? '' : 'background-color: #ff4444;';
                
                tableHTML += `
                    <tr>
                        <td style="width: 20%">${date}</td>
                        <td style="width: 20%">${mt5Value.toFixed(2)}</td>
                        <td style="width: 20%">${date}</td>
                        <td style="width: 20%">${metabaseValue.toFixed(2)}</td>
                        <td style="width: 20%; ${discrepancyStyle}">${displayDiscrepancy}</td>
                    </tr>
                `;
            });

            // Update the table with the new class
            const tableElement = document.getElementById("mt5Table");
            if (tableElement) {
                tableElement.className = 'combined-table';
                tableElement.innerHTML = tableHTML;
            }

            // Update summary with table format
            const summaryElement = document.getElementById("summaryResults");
            if (summaryElement) {
                let discrepancyAmount = (mt5Total - metabaseTotal).toFixed(2);
                let discrepancyColor = discrepancyAmount == 0 ? "#4CAF50" : "red";
                
                // Create message box based on conditions
                let messageBox = '';
                if (isMT5Missing || isMetabaseMissing) {
                    messageBox = `
                        <div style="
                            width: 100%;
                            margin-top: 10px;
                            padding: 10px;
                            background: #ffd700;
                            color: black;
                            text-align: center;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                            ${isMT5Missing ? "MT5 Report is missing" : "Metabase Report is missing"}
                        </div>
                    `;
                } else if (discrepancyAmount == 0) {
                    messageBox = `
                        <div style="
                            width: 100%;
                            margin-top: 10px;
                            padding: 10px;
                            background: #4CAF50;
                            color: white;
                            text-align: center;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                            MT5 report and Metabase matched, no discrepancies
                        </div>
                    `;
                } else {
                    messageBox = `
                        <div style="
                            width: 100%;
                            margin-top: 10px;
                            padding: 10px;
                            background: #ff4444;
                            color: white;
                            text-align: center;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                            There are discrepancies between MT5 report and Metabase
                        </div>
                    `;
                }

                let summaryHTML = `
                    <h3>Summary</h3>
                    <table style="width: 100%; margin-top: 10px;">
                        <tr>
                            <th>MT5 Report</th>
                            <th>Metabase Report</th>
                            <th>Discrepancies</th>
                        </tr>
                        <tr>
                            <td><strong style="font-size: 18px; color: #4CAF50;">${mt5Total.toFixed(2)}</strong></td>
                            <td><strong style="font-size: 18px; color: #4CAF50;">${metabaseTotal.toFixed(2)}</strong></td>
                            <td><strong style="font-size: 18px; color: ${discrepancyColor};">${discrepancyAmount}</strong></td>
                        </tr>
                    </table>
                    ${messageBox}
                `;
                summaryElement.innerHTML = summaryHTML;
            }
        }

        function analyzeData() {
            if (mt5Data.length === 0) {
                alert("Please upload both reports before analyzing.");
                return;
            }

            let totalMT5 = mt5Data.reduce((sum, row) => sum + row.profit, 0);
            
            // Get the total commission directly from the summaryResults
            let summaryElement = document.getElementById("summaryResults");
            let totalMetabase = parseFloat(summaryElement.querySelector('strong').textContent);

            let difference = totalMT5 - totalMetabase;

            let summaryHTML = `
                <h3>Summary</h3>
                <p>Total MT5 Commissions: <strong>${totalMT5.toFixed(2)}</strong></p>
                <p>Total Metabase Commissions: <strong>${totalMetabase.toFixed(2)}</strong></p>
                <p>Difference: <strong style="color: ${difference === 0 ? 'green' : 'red'}">${difference.toFixed(2)}</strong></p>
            `;
            document.getElementById("summaryResults").innerHTML = summaryHTML;

            drawChart(mt5Data, totalMetabase);
        }

        function drawChart(mt5, metabaseTotal) {
            const canvas = document.getElementById("comparisonChart");
            const ctx = canvas.getContext("2d");
            canvas.width = 800; 
            canvas.height = 300; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set white text color
            ctx.fillStyle = "white";
            ctx.font = "14px Arial";
            
            // Draw title
            ctx.fillText("Commission Comparison", 10, 20);
            
            // Draw MT5 data
            ctx.fillStyle = "green";
            let totalMT5 = mt5.reduce((sum, row) => sum + row.profit, 0);
            
            // Draw bars
            const barWidth = 100;
            const maxHeight = 200;
            
            // MT5 bar
            ctx.fillStyle = "green";
            const mt5Height = (totalMT5 / Math.max(totalMT5, metabaseTotal)) * maxHeight;
            ctx.fillRect(200, 280 - mt5Height, barWidth, mt5Height);
            
            // Metabase bar
            ctx.fillStyle = "red";
            const metabaseHeight = (metabaseTotal / Math.max(totalMT5, metabaseTotal)) * maxHeight;
            ctx.fillRect(350, 280 - metabaseHeight, barWidth, metabaseHeight);
            
            // Draw labels
            ctx.fillStyle = "white";
            ctx.fillText(`MT5: ${totalMT5.toFixed(2)}`, 200, 295);
            ctx.fillText(`Metabase: ${metabaseTotal.toFixed(2)}`, 350, 295);
        }

        function resetFiles() {
            // Clear file inputs
            document.getElementById('mt5Report').value = '';
            document.getElementById('metabaseReport').value = '';
            
            // Reset the MT5 table while preserving headers
            const mt5Table = document.getElementById('mt5Table');
            mt5Table.innerHTML = `
                <tr>
                    <th colspan="2" style="width: 40%">MT5</th>
                    <th colspan="2" style="width: 40%">Metabase</th>
                    <th style="width: 20%">Discrepancies</th>
                </tr>
                <tr>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Commission</th>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Recalculated Commission</th>
                    <th style="width: 20%">Difference</th>
                </tr>
            `;
            
            // Hide metabase table
            document.getElementById('metabaseTable').style.display = 'none';
            
            // Clear the summary results
            document.getElementById('summaryResults').innerHTML = '';
            
            // Reset any global variables
            window.mt5CommissionData = null;
            window.metabaseCommissionData = null;
            window.mt5Total = 0;
            window.metabaseTotal = 0;
        }

        function removeFile(inputId) {
            const fileInput = document.getElementById(inputId);
            fileInput.value = '';
            
            // Reset corresponding data
            if (inputId === 'mt5Report') {
                window.mt5CommissionData = null;
                window.mt5Total = 0;
            } else if (inputId === 'metabaseReport') {
                window.metabaseCommissionData = null;
                window.metabaseTotal = 0;
            }
            
            // Update the display
            updateSummaryAndTable();
        }
    </script>

</body>
</html>