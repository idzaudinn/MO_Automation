<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Payout Analysis</title>
    <style>
        /* Dark, professional theme */
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #ddd;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: left;
            margin: 0 0 10px 0;  /* Remove left margin */
            font-size: 24px;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 10px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        h2 {
            text-align: left;
            margin: 0 0 20px 0;  /* Remove left margin */
            font-size: 18px;
            font-weight: normal;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 20px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #bbb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #444;
            color: #fff;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #444;
        }
        th, td {
            padding: 8px;
            border: 1px solid #666;
            text-align: left;
        }
        th {
            background: #555;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        canvas {
            width: 100%;
            max-height: 300px;
            background: #111;
        }
        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .table-wrapper {
            flex: 1;
        }
        .combined-table th,
        .combined-table td {
            width: 20%;
            text-align: center;
        }

        /* Add these new styles */
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: auto;
            margin-top: 20px;
        }

        .left-side {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 400px;  /* Fixed width of 400px */
        }

        .left-column, .right-column, .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .right-column {
            flex: 1;  /* Takes remaining space */
        }

        .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            text-align: left;  /* Ensure all text aligns left */
        }

        .instruction-box h3 {
            text-align: left;  /* Ensure header is also left-aligned */
            margin-bottom: 15px;
        }

        .instruction-box ol {
            color: #fff;
            margin-left: 20px;
            line-height: 1.0;
            padding-left: 0;  /* Reduce default padding */
            text-align: left;
        }

        .instruction-box li {
            text-align: left;
            margin-bottom: 8px;  /* Add some spacing between list items */
        }

        /* Update container style */
        .container {
            max-width: none;
            margin: 0;
            background: none;
            padding: 0;
            box-shadow: none;
        }

        /* Adjust table wrapper for right column */
        .tables-container {
            margin-top: 0;
        }

        .table-wrapper {
            margin-top: 20px;
        }
        
        /* Add hyperlink styles */
        a {
            color: #66b3ff;  /* Light blue color */
            text-decoration: none;  /* Removes underline */
        }

        a:hover {
            color: #99ccff;  /* Slightly lighter blue on hover */
            text-decoration: underline;  /* Adds underline on hover */
        }

        a:visited {
            color: #66b3ff;  /* Keeps visited links the same color */
        }

        a:active {
            color: #3399ff;  /* Slightly darker when clicked */
        }

        /* Add button styling */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: background-color 0.3s;
            background-color: #ff4444;
            color: white;
        }

        button:hover {
            background-color: #ff0000;
        }

        /* Remove the analyze button specific styles */
        #analyzeBtn {
            display: none;
        }

        /* Add these new styles */
        .file-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-input-group input[type="file"] {
            flex: 1;
            margin-bottom: 0;  /* Override previous margin */
        }

        .remove-file-btn {
            background: #ff4444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: auto;  /* Override previous width: 100% */
        }

        .remove-file-btn:hover {
            background: #ff0000;
        }

        /* Add styles for the data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #444;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #666;
        }

        .data-table th {
            background: #555;
            font-weight: bold;
            color: #fff;
        }

        .data-table tr:nth-child(even) {
            background: #3a3a3a;
        }

        .data-table tr:hover {
            background: #4a4a4a;
        }

        .data-table td {
            color: #ddd;
        }

        /* Add horizontal scroll for table */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Commission Payout Analysis</h1>
    <h2>Use this tool to check the general commissions data between MT5, Metabase and to find the discrepancies based on the report dates. 
        Please use the main affiliate report for the analysis</h2>

    <div class="main-container">
        <!-- Left Side (contains both upper and lower sections) -->
        <div class="left-side">
            <!-- Upper Left Section -->
            <div class="left-column">
                <!-- File Inputs -->
                <div class="upload-section">
                    <h3>Upload Files</h3>
                    
                    <label for="metabaseReport">Metabase Report (CSV)</label>
                    <div class="file-input-group">
                        <input type="file" id="metabaseReport" accept=".csv">
                        <button class="remove-file-btn" onclick="removeFile('metabaseReport')">Remove</button>
                    </div>

                    <div class="button-group">
                        <button id="resetBtn" onclick="resetFiles()">Reset</button>
                    </div>
                </div>

                <!-- Summary Results -->
                <div class="results" id="summaryResults"></div>
            </div>

            <!-- Lower Left Section - Instructions -->
            <div class="instruction-box">
                <h3>Instructions</h3>
                <ol>
                    <li>Upload MT5 Report (HTML format)</li>
                    <li>Upload Metabase Report (CSV format)</li>
                    <li>The results will be displayed in the right column</li>
                    <li>Review the Summary for any discrepancies</li>
                </ol>
                <h3>MT5 Report</h3>
                <ol>
                    <li>Please fetch the MT5 report from the <a href="https://deriv-group.slack.com/archives/C03EAHR4P2L" target="_blank"><i>#sideoffice_mt5</i></a> channel</li>
                    <li>Save the generated file</li>
                    <li>Upload the MT5 report to the <i>Upload MT5 Report (HTML)</i> section</li>
                </ol>
                <h3>Metabase Report</h3>
                <ol>
                    <li>Please fetch the Metabase report from <a href="https://metabase-bi.4x.my/dashboard/1446-marketing-assistance-response-keyworker-dashboard?affiliate_id=266497&client_cr=&client_mt5_=&end_date=&ib_main_mt5=&start_date=&tab=272-ai-initiative-1" target="_blank"><i>Metabase Agent_MARK</i></a> channel</li>
                    <li>Save the generated file as CSV</li>
                    <li>Upload the Metabase report to the <i>Upload Metabase Report (CSV)</i> section</li>
                </ol>
                    
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Empty container for future content -->
        </div>
    </div>

    <!-- Move canvas outside or remove if not needed -->
    <canvas id="comparisonChart" style="display: none;"></canvas>

    <script>
        let mt5Data = [];
        let metabaseData = [];

        document.getElementById('metabaseReport').addEventListener('change', function(event) {
            const file = event.target.files[0];
            readMetabaseFile(file);
        });

        function standardizeDateFormat(dateString) {
            try {
                // Remove any quotes and trim whitespace
                dateString = dateString.replace(/"/g, '').trim();
                
                // Handle DD-MM-YYYY format
                if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                    let [day, month, year] = dateString.split('-');
                    return `${year}-${month}-${day}`;
                }
                
                // Handle DD.MM.YYYY format
                if (dateString.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    let [day, month, year] = dateString.split('.');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                // If already in YYYY-MM-DD format, return as is
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateString;
                }

                // For any other format, parse and convert
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                // Format as YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Error parsing date:', dateString);
                return dateString;
            }
        }

        function readMetabaseFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split("\n").map(line => line.trim());

                let metabaseData = {};
                let totalCommission = 0;
                let tableData = [];

                // Get headers from first line
                const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g).map(h => h.replace(/"/g, '').trim());

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;

                    let row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g);
                    
                    if (row.length >= 7) {
                        try {
                            let standardDate = standardizeDateFormat(row[0]);
                            let commission = parseFloat(row[4].replace(/"/g, '').trim());

                            if (!isNaN(commission)) { 
                                metabaseData[standardDate] = (metabaseData[standardDate] || 0) + commission;
                                totalCommission += commission;
                            }

                            // Store row data for table display
                            tableData.push({
                                date: standardDate,
                                Affiliate_MT5: row[1].replace(/"/g, '').replace(/,/g, '').trim(),
                                Deal_ID: row[2].replace(/"/g, '').replace(/,/g, '').trim(),
                                IB_account_type: row[3].replace(/"/g, '').trim(),
                                Commission: commission.toFixed(2),
                                MT5_Comment: row[5].replace(/"/g, '').trim(),
                                Commission_Type: row[6].replace(/"/g, '').trim()
                            });
                        } catch (e) {
                            console.error('Error processing row:', row, e);
                        }
                    }
                }

                window.metabaseCommissionData = metabaseData;
                window.metabaseTotal = totalCommission;
                window.tableData = tableData;
                
                console.log('Metabase Data after standardization:', metabaseData);
                updateSummaryAndTable();
                displayDataTable();
            };
            reader.readAsText(file);
        }

        function displayDataTable() {
            const rightColumn = document.querySelector('.right-column');
            const tableData = window.tableData || [];

            let tableHTML = `
                <div class="table-wrapper">
                    <h3>Commission Data</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Affiliate MT5</th>
                                <th>Deal ID</th>
                                <th>IB Account Type</th>
                                <th>Commission</th>
                                <th>MT5 Comment</th>
                                <th>Commission Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            tableData.forEach(row => {
                tableHTML += `
                    <tr>
                        <td>${row.date}</td>
                        <td>${row.Affiliate_MT5}</td>
                        <td>${row.Deal_ID}</td>
                        <td>${row.IB_account_type}</td>
                        <td>${row.Commission}</td>
                        <td>${row.MT5_Comment}</td>
                        <td>${row.Commission_Type}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            rightColumn.innerHTML = tableHTML;
        }

        function updateSummaryAndTable() {
            const metabaseData = window.metabaseCommissionData || {};
            const metabaseTotal = window.metabaseTotal || 0;

            // Check if metabase report is missing
            const isMetabaseMissing = Object.keys(metabaseData).length === 0;

            console.log('Updating table with:', { metabaseData }); // Debug log

            // Create combined set of dates
            let allDates = new Set(Object.keys(metabaseData));

            // Generate table HTML with the new class
            let tableHTML = `
                <tr>
                    <th colspan="2" style="width: 40%">Metabase</th>
                </tr>
                <tr>
                    <th style="width: 20%">Date</th>
                    <th style="width: 20%">Recalculated Commission</th>
                </tr>
            `;

            // Sort dates and create rows
            [...allDates].sort().forEach(date => {
                const metabaseValue = metabaseData[date] || 0;
                
                tableHTML += `
                    <tr>
                        <td style="width: 20%">${date}</td>
                        <td style="width: 20%">${metabaseValue.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Update the table with the new class
            const tableElement = document.getElementById("metabaseTable");
            if (tableElement) {
                tableElement.className = 'combined-table';
                tableElement.innerHTML = tableHTML;
            }

            // Update summary with table format
            const summaryElement = document.getElementById("summaryResults");
            if (summaryElement) {
                let discrepancyAmount = (metabaseTotal).toFixed(2);
                let discrepancyColor = discrepancyAmount == 0 ? "#4CAF50" : "red";
                
                // Create message box based on conditions
                let messageBox = '';
                if (isMetabaseMissing) {
                    messageBox = `
                        <div style="
                            width: 100%;
                            margin-top: 10px;
                            padding: 10px;
                            background: #ffd700;
                            color: black;
                            text-align: center;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                            Metabase Report is missing
                        </div>
                    `;
                } else {
                    messageBox = `
                        <div style="
                            width: 100%;
                            margin-top: 10px;
                            padding: 10px;
                            background: #4CAF50;
                            color: white;
                            text-align: center;
                            border-radius: 4px;
                            box-sizing: border-box;
                        ">
                            Metabase report is complete
                        </div>
                    `;
                }

                let summaryHTML = `
                    <h3>Summary</h3>
                    <table style="width: 100%; margin-top: 10px;">
                        <tr>
                            <th>Metabase Report</th>
                        </tr>
                        <tr>
                            <td><strong style="font-size: 18px; color: ${discrepancyColor};">${discrepancyAmount}</strong></td>
                        </tr>
                    </table>
                    ${messageBox}
                `;
                summaryElement.innerHTML = summaryHTML;
            }
        }

        function analyzeData() {
            if (metabaseData.length === 0) {
                alert("Please upload the Metabase report before analyzing.");
                return;
            }
            
            // Get the total commission directly from the summaryResults
            let summaryElement = document.getElementById("summaryResults");
            let totalMetabase = parseFloat(summaryElement.querySelector('strong').textContent);

            let summaryHTML = `
                <h3>Summary</h3>
                <p>Total Metabase Commissions: <strong>${totalMetabase.toFixed(2)}</strong></p>
            `;
            document.getElementById("summaryResults").innerHTML = summaryHTML;

            drawChart(metabaseData, totalMetabase);
        }

        function drawChart(metabase, metabaseTotal) {
            const canvas = document.getElementById("comparisonChart");
            const ctx = canvas.getContext("2d");
            canvas.width = 800; 
            canvas.height = 300; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Set white text color
            ctx.fillStyle = "white";
            ctx.font = "14px Arial";
            
            // Draw title
            ctx.fillText("Commission Comparison", 10, 20);
            
            // Draw Metabase data
            ctx.fillStyle = "red";
            let totalMetabase = metabase.reduce((sum, row) => sum + row.profit, 0);
            
            // Draw bars
            const barWidth = 100;
            const maxHeight = 200;
            
            // Metabase bar
            ctx.fillStyle = "red";
            const metabaseHeight = (totalMetabase / Math.max(totalMetabase, metabaseTotal)) * maxHeight;
            ctx.fillRect(200, 280 - metabaseHeight, barWidth, metabaseHeight);
            
            // Draw labels
            ctx.fillStyle = "white";
            ctx.fillText(`Metabase: ${totalMetabase.toFixed(2)}`, 200, 295);
        }

        function resetFiles() {
            // Clear file inputs
            document.getElementById('metabaseReport').value = '';
            
            // Clear the right column
            document.querySelector('.right-column').innerHTML = '';
            
            // Clear the summary results
            document.getElementById('summaryResults').innerHTML = '';
            
            // Reset any global variables
            window.metabaseCommissionData = null;
            window.metabaseTotal = 0;
            window.tableData = null;
        }

        function removeFile(inputId) {
            const fileInput = document.getElementById(inputId);
            fileInput.value = '';
            
            // Reset corresponding data
            if (inputId === 'metabaseReport') {
                window.metabaseCommissionData = null;
                window.metabaseTotal = 0;
            }
            
            // Update the display
            updateSummaryAndTable();
        }
    </script>

</body>
</html>