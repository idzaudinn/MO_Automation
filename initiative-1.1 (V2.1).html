<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Payout Analysis</title>
    <style>
        /* Dark, professional theme */
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #ddd;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: left;
            margin: 0 0 10px 0;  /* Remove left margin */
            font-size: 24px;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 10px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        h2 {
            text-align: left;
            margin: 0 0 20px 0;  /* Remove left margin */
            font-size: 18px;
            font-weight: normal;
            color: #fff;
            max-width: 1400px;  /* Match main-container max-width */
            margin: 0 auto 20px;  /* Center the container but keep text left-aligned */
            padding: 0 0 0 0;  /* Remove any padding */
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #bbb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #444;
            color: #fff;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #444;
        }
        th, td {
            padding: 8px;
            border: 1px solid #666;
            text-align: left;
        }
        th {
            background: #555;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        canvas {
            width: 100%;
            max-height: 300px;
            background: #111;
        }
        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .table-wrapper {
            flex: 1;
        }
        .combined-table th,
        .combined-table td {
            width: 20%;
            text-align: center;
        }

        /* Add these new styles */
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: auto;
            margin-top: 20px;
        }

        .left-side {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 400px;  /* Fixed width of 400px */
        }

        .left-column, .right-column, .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .right-column {
            flex: 1;  /* Takes remaining space */
        }

        .instruction-box {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            text-align: left;  /* Ensure all text aligns left */
        }

        .instruction-box h3 {
            text-align: left;  /* Ensure header is also left-aligned */
            margin-bottom: 15px;
        }

        .instruction-box ol {
            color: #fff;
            margin-left: 20px;
            line-height: 1.0;
            padding-left: 0;  /* Reduce default padding */
            text-align: left;
        }

        .instruction-box li {
            text-align: left;
            margin-bottom: 8px;  /* Add some spacing between list items */
        }

        /* Update container style */
        .container {
            max-width: none;
            margin: 0;
            background: none;
            padding: 0;
            box-shadow: none;
        }

        /* Adjust table wrapper for right column */
        .tables-container {
            margin-top: 0;
        }

        .table-wrapper {
            margin-top: 20px;
        }
        
        /* Add hyperlink styles */
        a {
            color: #66b3ff;  /* Light blue color */
            text-decoration: none;  /* Removes underline */
        }

        a:hover {
            color: #99ccff;  /* Slightly lighter blue on hover */
            text-decoration: underline;  /* Adds underline on hover */
        }

        a:visited {
            color: #66b3ff;  /* Keeps visited links the same color */
        }

        a:active {
            color: #3399ff;  /* Slightly darker when clicked */
        }

        /* Add button styling */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: background-color 0.3s;
            background-color: #ff4444;
            color: white;
        }

        button:hover {
            background-color: #ff0000;
        }

        /* Remove the analyze button specific styles */
        #analyzeBtn {
            display: none;
        }

        /* Add these new styles */
        .file-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-input-group input[type="file"] {
            flex: 1;
            margin-bottom: 0;  /* Override previous margin */
        }

        .remove-file-btn {
            background: #ff4444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: auto;  /* Override previous width: 100% */
        }

        .remove-file-btn:hover {
            background: #ff0000;
        }

        /* Add styles for the data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #444;
            font-size: 14px;
            table-layout: fixed;  /* Add this to make columns equal width */
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #666;
            overflow: hidden;  /* Add this to handle long content */
            text-overflow: ellipsis;  /* Add this to show ellipsis for long content */
            white-space: nowrap;  /* Add this to prevent text wrapping */
        }

        /* Add specific column widths for Transfer Summary tables */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1),
        .data-table th:nth-child(2),
        .data-table td:nth-child(2),
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: 33.33%;  /* Equal width for all three columns */
        }

        /* Add specific column widths for Commission Summary table */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1),
        .data-table th:nth-child(2),
        .data-table td:nth-child(2),
        .data-table th:nth-child(3),
        .data-table td:nth-child(3),
        .data-table th:nth-child(4),
        .data-table td:nth-child(4),
        .data-table th:nth-child(5),
        .data-table td:nth-child(5),
        .data-table th:nth-child(6),
        .data-table td:nth-child(6),
        .data-table th:nth-child(7),
        .data-table td:nth-child(7),
        .data-table th:nth-child(8),
        .data-table td:nth-child(8) {
            width: 12.5%;  /* Equal width for all eight columns */
        }

        /* Add specific column widths for Commission Data table */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1),
        .data-table th:nth-child(2),
        .data-table td:nth-child(2),
        .data-table th:nth-child(3),
        .data-table td:nth-child(3),
        .data-table th:nth-child(4),
        .data-table td:nth-child(4),
        .data-table th:nth-child(5),
        .data-table td:nth-child(5),
        .data-table th:nth-child(6),
        .data-table td:nth-child(6),
        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            width: 14.28%;  /* Equal width for all seven columns */
        }

        .data-table th {
            background: #555;
            font-weight: bold;
            color: #fff;
        }

        .data-table tr:nth-child(even) {
            background: #3a3a3a;
        }

        .data-table tr:hover {
            background: #4a4a4a;
        }

        .data-table td {
            color: #ddd;
        }

        /* Add horizontal scroll for table */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        /* Add styles for the top rectangle */
        .top-rectangle {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .top-rectangle h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
        }

        .summary-content {
            display: flex;
            gap: 30px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .summary-item .label {
            color: #bbb;
            font-size: 14px;
        }

        .summary-item .value {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>Commission Payout Analysis</h1>

    <div class="main-container">
        <!-- Left Side (contains both upper and lower sections) -->
        <div class="left-side">
            <!-- Upper Left Section -->
            <div class="left-column">
                <!-- File Inputs -->
                <div class="upload-section">
                    <h3>Upload Files</h3>
                    
                    <label for="metabaseReport">Metabase Report (CSV)</label>
                    <div class="file-input-group">
                        <input type="file" id="metabaseReport" accept=".csv">
                        <button class="remove-file-btn" onclick="resetFiles()">Reset</button>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #444; border-radius: 4px; color: #bbb;">
                        Uploaded file: <span id="uploadedFileName">No file uploaded</span>
                    </div>

                    <div class="button-group">
                        <!-- Remove the Reset button -->
                        <!-- <button id="resetBtn" onclick="resetFiles()">Reset</button> -->
                    </div>
                </div>
            </div>
            <!-- Lower Left Section - Instructions -->
            <div class="instruction-box">
                <h3>Instructions</h3>
                <ol>
                    <li>Please fetch the MT5 report from the <a href="https://metabase-bi.4x.my/dashboard/1446-marketing-assistance-response-keyworker-dashboard?affiliate_id=&client_cr=&client_mt5_=&end_date=&ib_main_mt5=930261&start_date=&tab=276-new" target="_blank"><i>Metabase</i></a></li>
                    <li>Upload the Metabase Report (CSV format)</li>
                    <li>The results will be displayed in the right column</li>
                    <li>Review the Summary for any discrepancies</li>
                </ol>
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Empty container for future content -->
        </div>
    </div>

    <!-- Move canvas outside or remove if not needed -->
    <canvas id="comparisonChart" style="display: none;"></canvas>

    <script>
        let mt5Data = [];
        let metabaseData = [];

        // Initialize the right column with Commission Summary when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const rightColumn = document.querySelector('.right-column');
            rightColumn.innerHTML = `
                <div class="top-rectangle">
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">AFF Main MT5</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <div style="color: #888;">No main account MT5s available</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">Results</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <div style="color: #888;">No results available</div>
                        </div>
                    </div>
                    <h3>Transfer Summary</h3>
                    <div class="table-wrapper" style="display: flex; gap: 20px;">
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>Technical Transfer</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>EOD on Tech</th>
                                    <th>Transfer to Main</th>
                                    <th>Not Transferred Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-wrapper" style="margin-top: 20px;">
                        <h3>Technical Transfer Summary by Server</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>IB Account Type</th>
                                    <th>Total Commission</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <h3 style="margin-top: 20px;">Results</h3>
                    <div class="table-wrapper">
                        <h3>Commission Summary</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Deal ID</th>
                                    <th>Server</th>
                                    <th>Technical Account</th>
                                    <th>Technical Date</th>
                                    <th>Main Account</th>
                                    <th>Main Date</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-wrapper">
                    <h3>Fetched Data</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Affiliate MT5</th>
                                <th>Deal ID</th>
                                <th>IB Account Type</th>
                                <th>Server</th>
                                <th>Commission</th>
                                <th>MT5 Comment</th>
                                <th>Commission Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align: center; color: #888;">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        });

        document.getElementById('metabaseReport').addEventListener('change', function(event) {
            const file = event.target.files[0];
            // Update the file name display
            const fileNameDisplay = document.getElementById('uploadedFileName');
            if (file) {
                fileNameDisplay.textContent = file.name;
            } else {
                fileNameDisplay.textContent = 'No file uploaded';
            }
            readMetabaseFile(file);
        });

        function standardizeDateFormat(dateString) {
            try {
                // Remove any quotes and trim whitespace
                dateString = dateString.replace(/"/g, '').trim();
                
                // Handle DD-MM-YYYY format
                if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
                    let [day, month, year] = dateString.split('-');
                    return `${year}-${month}-${day}`;
                }
                
                // Handle DD.MM.YYYY format
                if (dateString.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    let [day, month, year] = dateString.split('.');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                // If already in YYYY-MM-DD format, return as is
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateString;
                }

                // For any other format, parse and convert
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    throw new Error('Invalid date');
                }
                
                // Format as YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Error parsing date:', dateString);
                return dateString;
            }
        }

        function readMetabaseFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split("\n").map(line => line.trim());

                let metabaseData = {};
                let totalCommission = 0;
                let tableData = [];
                let transferStatus = {}; // New object to track transfer status
                let mainAccountCommissions = {}; // New object to track main account commissions

                // Get headers from first line
                const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g).map(h => h.replace(/"/g, '').trim());

                // First pass: collect all technical account entries
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;

                    let row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g);
                    
                    if (row.length >= 8) {  // Updated to check for 8 columns
                        try {
                            let standardDate = standardizeDateFormat(row[0]);
                            let commission = parseFloat(row[5].replace(/"/g, '').trim());  // Updated index to 5
                            let dealId = row[2].replace(/"/g, '').replace(/,/g, '').trim();
                            let accountType = row[3].replace(/"/g, '').trim();
                            let mt5Comment = row[6].replace(/"/g, '').trim();  // Updated index to 6
                            let server = row[4].replace(/"/g, '').trim();  // New server field

                            if (!isNaN(commission)) { 
                                metabaseData[standardDate] = (metabaseData[standardDate] || 0) + commission;
                                totalCommission += commission;
                            }

                            // Store row data for table display
                            tableData.push({
                                date: standardDate,
                                Affiliate_MT5: row[1].replace(/"/g, '').replace(/,/g, '').trim(),
                                Deal_ID: dealId,
                                IB_account_type: accountType,
                                Server: server,  // Add server to table data
                                Commission: commission.toFixed(2),
                                MT5_Comment: mt5Comment,
                                Commission_Type: row[7].replace(/"/g, '').trim()  // Updated index to 7
                            });

                            // Track technical account entries
                            if (accountType === 'technical') {
                                transferStatus[dealId] = {
                                    technicalDate: standardDate,
                                    technicalAccount: row[1].replace(/"/g, '').replace(/,/g, '').trim(),
                                    commission: commission,
                                    server: server,  // Add server to transfer status
                                    transferred: false
                                };
                            } else if (accountType === 'main') {
                                // Track main account commissions
                                const mainAccount = row[1].replace(/"/g, '').replace(/,/g, '').trim();
                                if (!mainAccountCommissions[mainAccount]) {
                                    mainAccountCommissions[mainAccount] = {
                                        totalCommission: 0,
                                        date: standardDate
                                    };
                                }
                                mainAccountCommissions[mainAccount].totalCommission += commission;
                            }
                        } catch (e) {
                            console.error('Error processing row:', row, e);
                        }
                    }
                }

                // Second pass: check for transfers in main accounts
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;

                    let row = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/g);
                    
                    if (row.length >= 8) {  // Updated to check for 8 columns
                        try {
                            let dealId = row[2].replace(/"/g, '').replace(/,/g, '').trim();
                            let accountType = row[3].replace(/"/g, '').trim();
                            let mt5Comment = row[6].replace(/"/g, '').trim();  // Updated index to 6
                            let standardDate = standardizeDateFormat(row[0]);

                            // Check if this is a main account entry
                            if (accountType === 'main') {
                                // Look for the deal ID in the MT5 comment
                                const commentDealId = mt5Comment.match(/deal (\d+)/);
                                if (commentDealId && commentDealId[1]) {
                                    const originalDealId = commentDealId[1];
                                    if (transferStatus[originalDealId]) {
                                        transferStatus[originalDealId] = {
                                            ...transferStatus[originalDealId],
                                            mainDate: standardDate,
                                            mainAccount: row[1].replace(/"/g, '').replace(/,/g, '').trim(),
                                            transferred: true
                                        };
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Error processing row:', row, e);
                        }
                    }
                }

                window.metabaseCommissionData = metabaseData;
                window.metabaseTotal = totalCommission;
                window.tableData = tableData;
                window.transferStatus = transferStatus;
                window.mainAccountCommissions = mainAccountCommissions;
                
                console.log('Transfer Status:', transferStatus); // Debug log
                updateSummaryAndTable();
                displayDataTable();
            };
            reader.readAsText(file);
        }

        function displayDataTable() {
            const rightColumn = document.querySelector('.right-column');
            const tableData = window.tableData || [];
            const transferStatus = window.transferStatus || {};
            const mainAccountCommissions = window.mainAccountCommissions || {};
            const totalCommission = window.metabaseTotal || 0;

            // Update the file name display with AFF Main MT5 value
            const fileNameDisplay = document.getElementById('uploadedFileName');
            const mainAccountMT5s = Object.keys(mainAccountCommissions);
            if (mainAccountMT5s.length > 0) {
                fileNameDisplay.textContent = mainAccountMT5s.join(', ');
            } else {
                fileNameDisplay.textContent = 'No AFF Main MT5 available';
            }

            // Count unique deals
            const uniqueDeals = new Set(tableData.map(row => row.Deal_ID)).size;

            // Count technical transfers
            const technicalTransferCount = tableData.filter(row => row.IB_account_type === 'technical').length;

            // Count transferred deals
            const transferredCount = Object.values(transferStatus).filter(status => status.transferred).length;
            const notTransferredCount = Object.values(transferStatus).filter(status => !status.transferred).length;

            // Calculate not transferred commission amount
            const notTransferredAmount = Object.values(transferStatus)
                .filter(status => !status.transferred)
                .reduce((sum, status) => sum + status.commission, 0);

            // Calculate EOD to Tech
            const eodTotal = tableData
                .filter(row => row.Commission_Type === 'EOD' && row.IB_account_type === 'technical')
                .reduce((sum, row) => sum + parseFloat(row.Commission), 0);

            // Calculate Main Transfer
            const mainTotal = Object.values(mainAccountCommissions)
                .reduce((sum, data) => sum + data.totalCommission, 0);

            // Get the date range from the data
            const dates = tableData.map(row => row.date);
            const minDate = new Date(Math.min(...dates.map(date => new Date(date))));
            const maxDate = new Date(Math.max(...dates.map(date => new Date(date))));

            // Create a set of all dates in the range for quick lookup
            const dateRangeSet = new Set(dates);

            // Filter out IBT to main entries where the EOD would be outside the date range
            const validMainTransfers = tableData.filter(row => {
                if (row.Commission_Type === 'IBT to main') {
                    // Extract deal ID from MT5 Comment
                    const dealMatch = row.MT5_Comment.match(/deal (\d+)/);
                    if (dealMatch && dealMatch[1]) {
                        const dealId = dealMatch[1];
                        // Find the corresponding technical entry
                        const technicalEntry = tableData.find(r => 
                            r.Deal_ID === dealId && 
                            r.IB_account_type === 'technical'
                        );
                        
                        // If we found the technical entry and its date is within our range, include this transfer
                        if (technicalEntry && dateRangeSet.has(technicalEntry.date)) {
                            return true;
                        }
                    }
                    return false;
                }
                return true;
            });

            // Recalculate mainTotal using only valid transfers
            const adjustedMainTotal = validMainTransfers
                .filter(row => row.Commission_Type === 'IBT to main')
                .reduce((sum, row) => sum + parseFloat(row.Commission), 0);

            // Calculate server-wise statistics
            const serverStats = {};
            
            // First, initialize stats for all servers from tableData
            tableData.forEach(row => {
                if (!serverStats[row.Server]) {
                    serverStats[row.Server] = {
                        totalCommission: 0,
                        transferred: 0,
                        notTransferred: 0,
                        ibAccountType: row.IB_account_type // Add IB Account Type
                    };
                }
                serverStats[row.Server].totalCommission += parseFloat(row.Commission);
            });

            // Create a map of transferred deals
            const transferredDeals = new Map();
            tableData.forEach(row => {
                if (row.Commission_Type === 'IBT to main') {
                    // Extract deal ID from MT5 Comment
                    const dealMatch = row.MT5_Comment.match(/deal (\d+)/);
                    if (dealMatch && dealMatch[1]) {
                        transferredDeals.set(dealMatch[1], parseFloat(row.Commission));
                    }
                }
            });

            // Update transfer status counts and amounts
            tableData.forEach(row => {
                if (row.IB_account_type === 'technical') {
                    const dealId = row.Deal_ID;
                    if (transferredDeals.has(dealId)) {
                        serverStats[row.Server].transferred += transferredDeals.get(dealId);
                    } else {
                        serverStats[row.Server].notTransferred += parseFloat(row.Commission);
                    }
                }
            });

            // Calculate total commission for Main accounts from Technical Transfer Summary by Server
            const mainAccountTotalCommission = Object.values(serverStats)
                .filter(stats => stats.ibAccountType === 'main')
                .reduce((sum, stats) => sum + stats.totalCommission, 0);

            // Calculate total of Main account commissions and successful transfers
            const totalMainAndTransfers = mainAccountTotalCommission + adjustedMainTotal;

            let tableHTML = `
                <div class="top-rectangle">
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">AFF Main MT5</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            `;

            // Add main account MT5s
            if (mainAccountMT5s.length > 0) {
                mainAccountMT5s.forEach(mt5 => {
                    tableHTML += `
                        <div style="background: #555; padding: 8px 12px; border-radius: 4px; color: #4CAF50;">
                            ${mt5}
                        </div>
                    `;
                });
            } else {
                tableHTML += `
                    <div style="color: #888;">No main account MT5s available</div>
                `;
            }

            tableHTML += `
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">Results</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; color: #ddd; line-height: 1.5;">
                            <div>
                                A total of ${technicalTransferCount.toLocaleString()} technical transactions were processed, from which ${transferredCount.toLocaleString()} were successfully transferred. This leaves ${notTransferredCount.toLocaleString()} transactions not transferred.
                            </div>
                            <div>
                                From an end-of-day (EOD), the total amount to be transferred to technical accounts was $${eodTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}. Out of this, $${adjustedMainTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} has been successfully transferred to main, with $${notTransferredAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} still pending.
                            </div>
                            <div style="color: ${eodTotal !== adjustedMainTotal ? '#ff4444' : '#4CAF50'}">
                                ${eodTotal === adjustedMainTotal ? 'The EOD and Main Transfer amounts are balanced.' : 'Warning: The EOD and Main Transfer amounts are unbalanced.'}
                            </div>
                        </div>
                    </div>
                    <h3>Transfer Summary</h3>
                    <div class="table-wrapper" style="display: flex; gap: 20px;">
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>Technical Transfer</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${technicalTransferCount.toLocaleString()}</td>
                                    <td>${transferredCount.toLocaleString()}</td>
                                    <td style="color: ${notTransferredCount > 0 ? '#ff4444' : '#4CAF50'}">${notTransferredCount.toLocaleString()}</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>EOD on Tech</th>
                                    <th>Transfer to Main</th>
                                    <th>Not Transferred Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>$${eodTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td>$${adjustedMainTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td style="color: ${notTransferredAmount > 0 ? '#ff4444' : '#4CAF50'}">$${notTransferredAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-wrapper" style="margin-top: 20px;">
                        <h3>Technical Transfer Summary by Server</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>IB Account Type</th>
                                    <th>Total Commission</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add server-wise statistics to the table
            if (Object.keys(serverStats).length > 0) {
                Object.entries(serverStats).forEach(([server, stats]) => {
                    tableHTML += `
                        <tr>
                            <td>${server}</td>
                            <td>${stats.ibAccountType || '-'}</td>
                            <td>$${stats.totalCommission.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td>$${stats.transferred.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td style="color: ${stats.notTransferred > 0 ? '#ff4444' : '#4CAF50'}">$${stats.notTransferred.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
            } else {
                tableHTML += `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #888;">No data available</td>
                    </tr>
                `;
            }

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <h3 style="margin-top: 20px;">Results</h3>
                    <div class="table-wrapper">
                        <h3>Commission Summary</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Deal ID</th>
                                    <th>Server</th>
                                    <th>Technical Account</th>
                                    <th>Technical Date</th>
                                    <th>Main Account</th>
                                    <th>Main Date</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add transfer status rows
            Object.entries(transferStatus).forEach(([dealId, status]) => {
                // Get current date and yesterday's date
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // Format dates for comparison
                const todayStr = today.toISOString().split('T')[0];
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                // Only show Not Transferred entries
                if (!status.transferred) {
                    let statusText = 'Not Transferred';
                    let statusColor = '#ff4444';
                    
                    // Check if the technical date is yesterday
                    if (status.technicalDate === yesterdayStr) {
                        statusText = 'Pending';
                        statusColor = '#ffd700'; // Yellow color
                    }
                    
                    tableHTML += `
                        <tr>
                            <td>${dealId}</td>
                            <td>${status.server || '-'}</td>
                            <td>${status.technicalAccount || '-'}</td>
                            <td>${status.technicalDate || '-'}</td>
                            <td>${status.mainAccount || '-'}</td>
                            <td>${status.mainDate || '-'}</td>
                            <td>${status.commission.toFixed(2)}</td>
                            <td style="color: ${statusColor}">${statusText}</td>
                        </tr>
                    `;
                }
            });

            // Remove main account rows since we only want to show Not Transferred entries
            if (Object.keys(transferStatus).filter(dealId => !transferStatus[dealId].transferred).length === 0) {
                tableHTML += `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #888;">No Not Transferred entries available</td>
                    </tr>
                `;
            }

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-wrapper">
                    <h3>Fetched Data</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Affiliate MT5</th>
                                <th>Deal ID</th>
                                <th>IB Account Type</th>
                                <th>Server</th>
                                <th>Commission</th>
                                <th>MT5 Comment</th>
                                <th>Commission Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (tableData.length > 0) {
                tableData.forEach(row => {
                    tableHTML += `
                        <tr>
                            <td>${row.date}</td>
                            <td>${row.Affiliate_MT5}</td>
                            <td>${row.Deal_ID}</td>
                            <td>${row.IB_account_type}</td>
                            <td>${row.Server}</td>
                            <td>${row.Commission}</td>
                            <td>${row.MT5_Comment}</td>
                            <td>${row.Commission_Type}</td>
                        </tr>
                    `;
                });
            } else {
                tableHTML += `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #888;">No data available</td>
                    </tr>
                `;
            }

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            rightColumn.innerHTML = tableHTML;
        }

        function updateSummaryAndTable() {
            const metabaseData = window.metabaseCommissionData || {};
            const metabaseTotal = window.metabaseTotal || 0;

            // Create message box based on conditions
            let messageBox = '';

            // Update the message in the left column
            const leftColumn = document.querySelector('.left-column');
            leftColumn.innerHTML = `
                <div class="upload-section">
                    <h3>Upload Files</h3>
                    
                    <label for="metabaseReport">Metabase Report (CSV)</label>
                    <div class="file-input-group">
                        <input type="file" id="metabaseReport" accept=".csv">
                        <button class="remove-file-btn" onclick="resetFiles()">Reset</button>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #444; border-radius: 4px; color: #bbb;">
                        Uploaded file: <span id="uploadedFileName">No file uploaded</span>
                    </div>

                    <div class="button-group">
                        <!-- Remove the Reset button -->
                        <!-- <button id="resetBtn" onclick="resetFiles()">Reset</button> -->
                    </div>
                </div>
                ${messageBox}
            `;

            // Reattach the event listener for the file input
            document.getElementById('metabaseReport').addEventListener('change', function(event) {
                const file = event.target.files[0];
                readMetabaseFile(file);
            });
        }

        function resetFiles() {
            // Clear file inputs
            document.getElementById('metabaseReport').value = '';
            
            // Reset the file name display
            document.getElementById('uploadedFileName').textContent = 'No file uploaded';
            
            // Reset any global variables
            window.metabaseCommissionData = null;
            window.metabaseTotal = 0;
            window.tableData = null;
            window.transferStatus = null;
            window.mainAccountCommissions = null;

            // Reinitialize the right column with empty tables
            const rightColumn = document.querySelector('.right-column');
            rightColumn.innerHTML = `
                <div class="top-rectangle">
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">AFF Main MT5</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <div style="color: #888;">No main account MT5s available</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; padding: 15px; background: #444; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0;">Results</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <div style="color: #888;">No results available</div>
                        </div>
                    </div>
                    <h3>Transfer Summary</h3>
                    <div class="table-wrapper" style="display: flex; gap: 20px;">
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>Technical Transfer</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="data-table" style="margin-top: 0; flex: 1;">
                            <thead>
                                <tr>
                                    <th>EOD on Tech</th>
                                    <th>Transfer to Main</th>
                                    <th>Not Transferred Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-wrapper" style="margin-top: 20px;">
                        <h3>Technical Transfer Summary by Server</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Server</th>
                                    <th>IB Account Type</th>
                                    <th>Total Commission</th>
                                    <th>Transferred</th>
                                    <th>Not Transferred</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <h3 style="margin-top: 20px;">Results</h3>
                    <div class="table-wrapper">
                        <h3>Commission Summary</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Deal ID</th>
                                    <th>Server</th>
                                    <th>Technical Account</th>
                                    <th>Technical Date</th>
                                    <th>Main Account</th>
                                    <th>Main Date</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" style="text-align: center; color: #888;">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-wrapper">
                    <h3>Fetched Data</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Affiliate MT5</th>
                                <th>Deal ID</th>
                                <th>IB Account Type</th>
                                <th>Server</th>
                                <th>Commission</th>
                                <th>MT5 Comment</th>
                                <th>Commission Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align: center; color: #888;">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // Reset the left column to show only the upload section
            const leftColumn = document.querySelector('.left-column');
            leftColumn.innerHTML = `
                <div class="upload-section">
                    <h3>Upload Files</h3>
                    
                    <label for="metabaseReport">Metabase Report (CSV)</label>
                    <div class="file-input-group">
                        <input type="file" id="metabaseReport" accept=".csv">
                        <button class="remove-file-btn" onclick="resetFiles()">Reset</button>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #444; border-radius: 4px; color: #bbb;">
                        Uploaded file: <span id="uploadedFileName">No file uploaded</span>
                    </div>

                    <div class="button-group">
                        <!-- Remove the Reset button -->
                        <!-- <button id="resetBtn" onclick="resetFiles()">Reset</button> -->
                    </div>
                </div>
            `;

            // Reattach the event listener for the file input
            document.getElementById('metabaseReport').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('uploadedFileName').textContent = file.name;
                    readMetabaseFile(file);
                }
            });
        }
    </script>

</body>
</html>